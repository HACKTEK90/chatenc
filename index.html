<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Encrypted Chat App</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">
</head>
<body>
  <div id="userInfo">
    <h1>Enter your Details</h1>
    <input type="text" id="userName" placeholder="Enter your name" />
    <select id="userCountry">
      <option value="" disabled selected>Select your country</option>
      <option value="USA">USA</option>
      <option value="Canada">Canada</option>
      <option value="UK">UK</option>
      <option value="India">India</option>
      <option value="Australia">Australia</option>
    </select>
    <button id="startChatButton">Start Chat</button>
  </div>

  <div id="app" style="display:none;">
    <h1>Encrypted Public Chat</h1>

    <div class="info-container">
      <button class="info-icon">i</button>
      <div class="info-text">Chat anonymously without revealing your identity. Stay safe and secure. Messages will get deleted within 24hr.</div>
    </div>

    <div class="footer-note">Made with ❤️ in India</div>

    <div id="chat">
      <div id="typingStatus" style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;"></div>
    </div>

    <div id="messageForm">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <input type="file" id="imageInput" />
      <button onclick="uploadImage()">Upload Image</button>
      <button id="sendMessageButton">Send</button>
    </div>
  </div>

  <script>
    function uploadImage() {
      const file = document.getElementById('imageInput').files[0];
      if (!file) {
        alert("Please select an image to upload!");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "chat_uploads"); // your preset name

      fetch("https://api.cloudinary.com/v1_1/dvna7up5c/image/upload", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        console.log("Uploaded!", data.secure_url);
        // You can send this image URL along with the message
        sendMessageWithImage(data.secure_url);
      })
      .catch(err => console.error("Upload error", err));
    }

    function sendMessageWithImage(imageUrl) {
      const userName = document.getElementById('userName').value.trim();
      const userCountry = document.getElementById('userCountry').value;
      const messagesRef = ref(db, 'chats/chat1/messages');
      const newMessageRef = push(messagesRef);
      set(newMessageRef, {
        userName,
        userCountry,
        imageUrl: imageUrl,
        timestamp: Date.now()
      });
    }

    const startChatButton = document.getElementById('startChatButton');
    const sendMessageButton = document.getElementById('sendMessageButton');
    const messageInput = document.getElementById('messageInput');
    const chatDiv = document.getElementById('chat');
    const userNameInput = document.getElementById('userName');
    const userCountryInput = document.getElementById('userCountry');
    const userInfoSection = document.getElementById('userInfo');
    const chatAppSection = document.getElementById('app');

    let userName = '';
    let userCountry = '';

    startChatButton.addEventListener('click', () => {
      userName = userNameInput.value.trim();
      userCountry = userCountryInput.value;

      if (userName && userCountry) {
        userInfoSection.style.display = 'none';
        chatAppSection.style.display = 'flex';
      } else {
        alert('Please enter your name and select a country!');
      }
    });

    sendMessageButton.addEventListener('click', () => {
      const message = messageInput.value.trim();
      if (message) {
        const encrypted = encryptMessage(message);
        const messagesRef = ref(db, 'chats/chat1/messages');
        const newMessageRef = push(messagesRef);
        set(newMessageRef, {
          userName,
          userCountry,
          text: encrypted,
          timestamp: Date.now()
        });
        messageInput.value = '';
      }
    });

    function encryptMessage(message) {
      return message.split('').map(ch => String.fromCharCode(ch.charCodeAt(0) + 3)).join('');
    }

    function decryptMessage(message) {
      return message.split('').map(ch => String.fromCharCode(ch.charCodeAt(0) - 3)).join('');
    }

    onValue(ref(db, 'chats/chat1/messages'), (snapshot) => {
      const messages = snapshot.val();
      chatDiv.innerHTML = '';
      for (let id in messages) {
        const msg = messages[id];
        const decrypted = decryptMessage(msg.text);
        const div = document.createElement('div');
        div.classList.add('chat-message');
        div.innerHTML = `<strong>${msg.userName} (${msg.userCountry})</strong> <small>${new Date(msg.timestamp).toLocaleString()}</small><br>${decrypted}`;
        if (msg.imageUrl) {
          div.innerHTML += `<br><img src="${msg.imageUrl}" alt="Uploaded Image" style="max-width: 100%; height: auto; margin-top: 10px;" />`;
        }
        chatDiv.appendChild(div);
      }
    });

    function cleanupOldMessages() {
      const messagesRef = ref(db, 'chats/chat1/messages');
      onValue(messagesRef, (snapshot) => {
        const messages = snapshot.val();
        const now = Date.now();
        for (let id in messages) {
          if (now - messages[id].timestamp > 86400000) {
            remove(ref(db, 'chats/chat1/messages/' + id));
          }
        }
      });
    }

    cleanupOldMessages();
  </script>
</body>
</html>
